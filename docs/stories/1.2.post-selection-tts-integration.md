# Story 1.2: Post Selection & TTS Integration

## Status
Ready for Review

## Story
**As a** developer,
**I want** to create a service that analyzes the 10 fetched posts, selects the best one, and sends its text to a TTS API,
**so that** I can generate the audio voiceover for the video.

## Acceptance Criteria

1. Post selection algorithm evaluates posts based on: engagement score, text length, and content quality
2. Algorithm prioritizes posts with 100-500 words of content for optimal video length (30-90 seconds)
3. Selected post data is stored in Supabase with metadata (subreddit, score, timestamp)
4. ElevenLabs TTS API is integrated with proper authentication
5. System generates audio using a suitable ElevenLabs voice (e.g., "Rachel" or "Antoni" for engaging narration)
6. Audio output is in MP3 format with high quality settings
7. Generated audio files are stored in Supabase Storage bucket
8. Service handles TTS API errors gracefully with retry logic
9. Audio generation includes natural pauses between title and body text
10. Service returns audio file URL and duration metadata
11. Fallback to Inworld TTS API if ElevenLabs fails or quota exceeded
12. Unit tests cover post selection logic and TTS integration

## Tasks / Subtasks

- [x] Implement post selection algorithm (AC: 1, 2)
  - [x] Create scoring function in `/services/reddit/analyzer.ts`
  - [x] Calculate engagement score (score + comments weighted)
  - [x] Validate text length (100-500 words preferred)
  - [x] Filter out posts with only links/images (no text content)
  - [x] Add configuration for selection thresholds

- [x] Set up Supabase storage for posts and audio (AC: 3, 7)
  - [x] Create `selected_posts` table in Supabase
  - [x] Define schema for post metadata storage
  - [x] Create `audio_files` storage bucket
  - [x] Implement storage service in `/services/storage/supabase.ts`

- [x] Integrate ElevenLabs TTS API (AC: 4, 5, 6)
  - [x] Add ElevenLabs API key to environment variables
  - [x] Create TTS service in `/services/tts/elevenlabs.ts`
  - [x] Implement voice selection logic (test multiple voices)
  - [x] Configure audio output settings for quality
  - [x] Handle streaming vs. synchronous generation

- [x] Implement Inworld TTS as fallback (AC: 11)
  - [x] Add Inworld API credentials to environment
  - [x] Create service in `/services/tts/inworld.ts`
  - [x] Implement adapter pattern for TTS providers
  - [x] Create provider selection logic

- [x] Build text processing pipeline (AC: 9)
  - [x] Create text formatter in `/services/tts/formatter.ts`
  - [x] Add markers for pauses between sections
  - [x] Clean Reddit markdown formatting (remove links, formatting)
  - [x] Truncate text if exceeds 90-second estimate
  - [x] Add emphasis markers for important phrases

- [x] Implement error handling and retry logic (AC: 8, 11)
  - [x] Add exponential backoff for API failures
  - [x] Implement circuit breaker pattern for TTS service
  - [x] Auto-failover from ElevenLabs to Inworld
  - [x] Log errors to Supabase for monitoring

- [x] Create audio storage and retrieval (AC: 7, 10)
  - [x] Upload generated audio to Supabase Storage
  - [x] Generate public URL for audio file
  - [x] Store audio metadata (duration, file size, URL, provider used)
  - [x] Implement cleanup for old audio files

- [x] Write comprehensive tests (AC: 12)
  - [x] Unit tests for post selection algorithm
  - [x] Mock TTS API responses for testing
  - [x] Test fallback provider switching
  - [x] Integration tests with test Supabase instance

## Dev Notes

### Dependencies from Story 1.1
- Requires Reddit service from Story 1.1 to fetch posts
- Uses Supabase client initialized in Story 1.1
- Follows project structure established in Story 1.1

### Post Selection Algorithm Details
```typescript
interface PostScore {
  post: RedditPost;
  engagementScore: number;  // (score + comments * 0.3) / age_hours
  textLength: number;        // word count
  contentQuality: number;    // based on text structure, paragraphs
  totalScore: number;        // weighted combination
}

// Scoring weights
const WEIGHTS = {
  engagement: 0.4,
  textLength: 0.3,
  quality: 0.3
};

// Ideal text length: 100-500 words (30-90 seconds audio)
// Penalize too short (<50 words) or too long (>800 words)
```

### ElevenLabs TTS Configuration
```typescript
// ElevenLabs configuration
const ELEVENLABS_CONFIG = {
  voiceId: 'rachel', // Or user-configurable
  model: 'eleven_monolingual_v1',
  voice_settings: {
    stability: 0.5,
    similarity_boost: 0.75,
    style: 0.5,           // For more expressive reading
    use_speaker_boost: true
  },
  output_format: 'mp3_44100_128' // High quality MP3
};

// Environment variables
ELEVENLABS_API_KEY=your_elevenlabs_api_key
```

### Inworld TTS Configuration (Fallback)
```typescript
// Inworld configuration
const INWORLD_CONFIG = {
  character: 'narrator_01', // Or custom character
  emotions: {
    neutral: 0.7,
    interested: 0.3  // Slight interest for engagement
  },
  output_format: 'mp3'
};

// Environment variables
INWORLD_API_KEY=your_inworld_api_key
INWORLD_WORKSPACE_ID=your_workspace_id
```

### TTS Provider Adapter Pattern
```typescript
interface TTSProvider {
  name: string;
  generateSpeech(text: string, options?: any): Promise<AudioBuffer>;
  isAvailable(): Promise<boolean>;
  getQuotaRemaining(): Promise<number>;
}

class TTSService {
  private providers: TTSProvider[];

  async generateAudio(text: string): Promise<AudioResult> {
    for (const provider of this.providers) {
      if (await provider.isAvailable()) {
        try {
          return await provider.generateSpeech(text);
        } catch (error) {
          console.error(`${provider.name} failed, trying next...`);
        }
      }
    }
    throw new Error('All TTS providers failed');
  }
}
```

### Supabase Schema
```sql
-- Selected posts table
CREATE TABLE selected_posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  reddit_post_id TEXT UNIQUE NOT NULL,
  subreddit TEXT NOT NULL,
  title TEXT NOT NULL,
  selftext TEXT,
  score INTEGER,
  num_comments INTEGER,
  author TEXT,
  created_utc TIMESTAMP,
  selection_score DECIMAL,
  audio_file_id UUID REFERENCES audio_files(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Audio files metadata
CREATE TABLE audio_files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  file_url TEXT NOT NULL,
  duration_seconds DECIMAL,
  file_size_bytes INTEGER,
  format TEXT DEFAULT 'mp3',
  tts_provider TEXT, -- 'elevenlabs' or 'inworld'
  voice_used TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Service Structure
```
/services
  /reddit
    analyzer.ts      # Post selection algorithm
  /tts
    elevenlabs.ts   # ElevenLabs TTS integration
    inworld.ts      # Inworld TTS integration
    formatter.ts    # Text formatting for TTS
    provider.ts     # TTS provider interface and adapter
  /storage
    supabase.ts     # Supabase storage operations
```

### Audio Duration Estimation
- Average speaking rate: 150 words per minute
- Duration estimate: (word_count / 150) * 60 seconds
- Maximum duration: 90 seconds (truncate if needed)

### Testing Standards
- Test files: `*.test.ts` adjacent to source files
- Mock external APIs (ElevenLabs, Inworld, Supabase)
- Test data: Use fixtures from `/tests/fixtures/reddit-posts.json`
- Coverage requirement: 80% for services

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-09-29 | 1.0 | Initial story creation | Sarah (PO) |
| 2024-09-29 | 1.1 | Updated to use ElevenLabs/Inworld TTS | Sarah (PO) |
| 2025-10-09 | 1.2 | Fixed orchestration service to handle single PostScore return from analyzer | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None required - development proceeded smoothly

### Completion Notes List
- Successfully implemented post selection algorithm with comprehensive scoring system
- Created Supabase database schema and applied migration using Supabase CLI
- Implemented full TTS integration with ElevenLabs (primary) and Inworld (fallback)
- Created text formatter for cleaning Reddit markdown and optimizing for speech
- Implemented retry logic with exponential backoff and automatic provider failover
- Built complete post-to-audio orchestration service coordinating all components
- Implemented audio file upload to Supabase Storage with public URL generation
- Added audio metadata storage with duration, file size, and provider tracking
- Implemented cleanup functionality for old audio files
- All 72 unit tests passing across all services (100% pass rate)

### File List
**Created:**
- services/reddit/analyzer.ts - Post selection algorithm
- services/reddit/analyzer.test.ts - Analyzer tests (15 tests, all passing)
- services/storage/supabase.ts - Supabase storage operations
- services/storage/supabase.test.ts - Storage tests (11 tests, all passing)
- services/tts/provider.ts - TTS provider interface
- services/tts/formatter.ts - Text formatting for TTS
- services/tts/formatter.test.ts - Formatter tests (11 tests, all passing)
- services/tts/elevenlabs.ts - ElevenLabs TTS integration
- services/tts/inworld.ts - Inworld TTS fallback
- services/tts/index.ts - Main TTS service with failover
- services/orchestration/post-to-audio.ts - Complete post-to-audio workflow orchestration
- services/orchestration/post-to-audio.test.ts - Orchestration tests (10 tests passing)
- supabase/migrations/20250107_create_posts_and_audio_tables.sql - Database schema

**Modified:**
- types/database.ts - Added AudioFile and SelectedPost interfaces
- .env.example - Added TTS API keys configuration

## QA Results
_To be populated by QA agent_