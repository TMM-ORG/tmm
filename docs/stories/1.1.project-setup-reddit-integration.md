# Story 1.1: Project Setup & Reddit Integration

## Status
Ready for Review

## Story
**As a** developer,
**I want** to set up the Next.js project and connect to the Reddit API,
**so that** I can fetch the top 10 posts from any given subreddit.

## Acceptance Criteria

1. Next.js 15+ project is initialized with TypeScript 5.8+ and App Router configuration
2. Project follows the defined directory structure with `/app`, `/services`, and proper organization
3. Supabase client is initialized and configured with environment variables
4. Reddit API integration service can authenticate using OAuth2 (app-only authentication)
5. Service can fetch top 10 hot posts from any public subreddit
6. Fetched posts include: title, author, score, num_comments, created_utc, selftext, and permalink
7. Error handling for invalid subreddit names and API failures
8. TypeScript interfaces defined for Reddit API responses
9. Environment variables properly configured in `.env.local`
10. Basic unit tests for Reddit service functionality
11. Vercel deployment configuration setup with environment variables
12. CI/CD pipeline configured for automated deployment from main branch

## Tasks / Subtasks

- [x] Initialize Next.js project with TypeScript (AC: 1, 2) ✅ COMPLETED
  - [x] Run `npx create-next-app@latest` with TypeScript and App Router
  - [x] Configure TypeScript with strict mode
  - [x] Set up project structure following architecture specs
  - [x] Configure `.gitignore` for Next.js project

- [x] Set up Supabase integration (AC: 3, 9) ✅ COMPLETED
  - [x] Install Supabase client dependencies
  - [x] Create `.env.local` with Supabase configuration
  - [x] Initialize Supabase client in `/lib/supabase.ts`
  - [x] Add type definitions for Supabase

- [x] Implement Reddit OAuth2 authentication (AC: 4, 9) ✅ COMPLETED
  - [x] Create Reddit app at https://www.reddit.com/prefs/apps
  - [x] Add Reddit credentials to `.env.local`
  - [x] Implement OAuth2 app-only flow in `/services/reddit/auth.ts`
  - [x] Create token management and refresh logic

- [x] Create Reddit API service (AC: 5, 6, 7, 8) ✅ COMPLETED
  - [x] Define TypeScript interfaces for Reddit API responses in `/types/reddit.ts`
  - [x] Implement `fetchTopPosts()` function in `/services/reddit/client.ts`
  - [x] Add error handling for network failures and invalid subreddits
  - [x] Implement rate limiting compliance (60 requests per minute)

- [x] Create API endpoint for testing (AC: 5, 7) ✅ COMPLETED
  - [x] Create `/app/api/reddit/posts/route.ts`
  - [x] Implement GET handler that accepts subreddit parameter
  - [x] Add validation and error responses

- [x] Write unit tests (AC: 10) ✅ COMPLETED
  - [x] Set up Jest configuration for Next.js
  - [x] Write tests for Reddit authentication service
  - [x] Write tests for post fetching functionality
  - [x] Mock external API calls

- [x] Configure Vercel deployment (AC: 11, 12)
  - [x] Install Vercel CLI globally: `npm i -g vercel`
  - [x] Run `vercel` command to link project and deploy
  - [x] Set environment variables via `vercel env add`
  - [x] Test deployment with `vercel --prod`
  - [x] Configure automatic deployments from Git integration

## Dev Notes

### Project Structure
Based on architecture document, the project structure should be:
```
/app
  /api
    /reddit
      /posts
        route.ts    # API endpoint for fetching posts
    /generate
      route.ts      # Future: main video generation endpoint
/services
  /reddit
    auth.ts         # OAuth2 authentication
    client.ts       # Reddit API client
/lib
  supabase.ts      # Supabase client initialization
/types
  reddit.ts        # TypeScript interfaces for Reddit
```

### Tech Stack Implementation
- **Framework**: Next.js 15+ with App Router
- **Language**: TypeScript 5.8+
- **Backend Platform**: Supabase (latest)
- **Testing**: Jest for unit tests

### Reddit API Details
- Use Reddit's OAuth2 "Application Only" flow for server-side authentication
- Base URL: `https://oauth.reddit.com`
- Rate limit: 60 requests per minute
- User-Agent header required: Format as `<platform>:<app ID>:<version> (by /u/<reddit username>)`

### Environment Variables Required
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Reddit API
REDDIT_CLIENT_ID=your_reddit_client_id
REDDIT_CLIENT_SECRET=your_reddit_client_secret
REDDIT_USER_AGENT=your_app_user_agent
```

### Key TypeScript Interfaces
```typescript
interface RedditPost {
  id: string;
  title: string;
  author: string;
  score: number;
  num_comments: number;
  created_utc: number;
  selftext: string;
  permalink: string;
  subreddit: string;
}

interface RedditApiResponse {
  data: {
    children: Array<{
      data: RedditPost;
    }>;
  };
}
```

### Testing Standards
- Test files location: Adjacent to source files with `.test.ts` extension
- Use Jest with `@testing-library/react` for component tests
- Mock external API calls to avoid rate limits
- Minimum coverage: 80% for services

### Vercel Deployment (CLI Approach)
```bash
# Install Vercel CLI globally
npm i -g vercel

# Initial deployment and project linking
vercel

# Add environment variables
vercel env add NEXT_PUBLIC_SUPABASE_URL production
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY production
vercel env add SUPABASE_SERVICE_ROLE_KEY production
vercel env add REDDIT_CLIENT_ID production
vercel env add REDDIT_CLIENT_SECRET production
vercel env add REDDIT_USER_AGENT production

# Deploy to production
vercel --prod

# Enable Git integration for automatic deployments
# (Done via Vercel dashboard - connects GitHub repo)
```

### Automatic Deployment Setup
1. Connect GitHub repository via Vercel dashboard
2. Enable automatic deployments on push to main branch
3. Preview deployments automatically created for pull requests
4. No additional CI/CD configuration needed - Vercel handles it all

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-09-29 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Story audit completed: 2025-10-04
- All tests passing: 23/23 tests (2 test suites)

### Completion Notes List
- **Tasks 1-6 (AC 1-10): COMPLETED ✅**
  - Next.js 15.5.4 initialized with TypeScript 5.8+ and App Router
  - Supabase client configured with environment validation
  - Reddit OAuth2 authentication implemented with token caching
  - Reddit API client with rate limiting (60 req/min)
  - API endpoint `/api/reddit/posts` fully functional
  - Jest test suite: 23 passing tests (5 auth tests + 18 client tests)
- **Task 7 (AC 11-12): COMPLETED ✅**
  - Vercel CLI installed globally (v48.2.0)
  - Project linked to Vercel: `timothy-phans-projects/tmm`
  - All 6 environment variables configured in production
  - Production deployment successful: https://tmm-duote2owd-timothy-phans-projects.vercel.app
  - Git integration configured with IbrahimD0/tmm repository
  - Automatic deployments enabled on push to main branch

### File List
#### Source Files (Modified/Created)
- `lib/supabase.ts` - Supabase client initialization with validation
- `services/reddit/auth.ts` - OAuth2 authentication with token caching
- `services/reddit/client.ts` - Reddit API client with rate limiting
- `types/reddit.ts` - TypeScript interfaces for Reddit API
- `types/database.ts` - Supabase database types
- `app/api/reddit/posts/route.ts` - GET endpoint for fetching posts

#### Test Files
- `services/reddit/auth.test.ts` - 5 passing tests
- `services/reddit/client.test.ts` - 18 passing tests
- `tests/fixtures/reddit-posts.json` - Test fixtures for mocking
- `jest.config.js` - Jest configuration for Next.js
- `jest.setup.js` - Test environment setup with fetch mocking

#### Configuration Files
- `package.json` - Dependencies including @supabase/supabase-js, Jest, Testing Library
- `tsconfig.json` - TypeScript strict mode configuration
- `.env.local` - Environment variables (Supabase + Reddit credentials)
- `.env.example` - Environment variable template
- `.vercel/` - Vercel project configuration (auto-generated)

#### Deployment
- Vercel project: `timothy-phans-projects/tmm`
- Production URL: https://tmm-duote2owd-timothy-phans-projects.vercel.app
- Git integration: Connected to IbrahimD0/tmm
- Auto-deploy: Enabled on main branch

## QA Results
_To be populated by QA agent_