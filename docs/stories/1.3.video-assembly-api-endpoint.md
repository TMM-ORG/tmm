# Story 1.3: Video Assembly & API Endpoint

## Status
Draft

## Story
**As a** developer,
**I want** to create a service that combines the generated audio with a background video and exposes this workflow via an API endpoint,
**so that** testers can trigger the video creation process and download the result.

## Acceptance Criteria

1. FFmpeg is properly integrated and configured for video processing
2. Background video library is stored in Supabase Storage with at least 5 generic videos
3. Video selection algorithm chooses appropriate background based on content mood/topic
4. FFmpeg combines audio and video with proper synchronization
5. Output video is in MP4 format (H.264 codec, 1080p resolution, 30fps)
6. Generated videos are stored in Supabase Storage with public URLs
7. Main API endpoint `/api/generate` orchestrates the complete workflow
8. API returns job ID immediately and processes video generation asynchronously
9. Status endpoint `/api/status/[jobId]` provides generation progress
10. Download endpoint returns video URL when processing is complete
11. Error handling covers all failure points with meaningful error messages
12. Basic rate limiting prevents abuse (1 request per minute per IP)
13. Integration tests verify complete workflow end-to-end
14. User documentation created for API endpoints and video generation process
15. API documentation includes examples and error handling guidance

## Tasks / Subtasks

- [ ] Set up FFmpeg integration (AC: 1)
  - [ ] Install ffmpeg-static package
  - [ ] Create FFmpeg wrapper service in `/services/video/ffmpeg.ts`
  - [ ] Configure FFmpeg command builder for video operations
  - [ ] Add error handling for FFmpeg process failures

- [ ] Create background video library (AC: 2, 3)
  - [ ] Set up `background_videos` storage bucket in Supabase
  - [ ] Upload initial set of royalty-free background videos
  - [ ] Create metadata table for video categorization
  - [ ] Implement video selection algorithm in `/services/video/selector.ts`

- [ ] Implement video assembly service (AC: 4, 5, 6)
  - [ ] Create video processor in `/services/video/processor.ts`
  - [ ] Implement audio/video synchronization logic
  - [ ] Configure output settings (H.264, 1080p, 30fps)
  - [ ] Add text overlay capability for title/username (future enhancement)
  - [ ] Upload processed videos to Supabase Storage

- [ ] Build job queue system (AC: 8, 9)
  - [ ] Create `video_jobs` table in Supabase
  - [ ] Implement job queue in `/services/queue/jobs.ts`
  - [ ] Add job status tracking (pending, processing, completed, failed)
  - [ ] Create background worker for async processing
  - [ ] Implement progress updates during processing

- [ ] Create main generation API endpoint (AC: 7, 8)
  - [ ] Implement POST `/app/api/generate/route.ts`
  - [ ] Validate request parameters (subreddit name)
  - [ ] Create job and return job ID immediately
  - [ ] Trigger async workflow orchestration
  - [ ] Add request logging for debugging

- [ ] Implement status and download endpoints (AC: 9, 10)
  - [ ] Create GET `/app/api/status/[jobId]/route.ts`
  - [ ] Return job status and progress percentage
  - [ ] Create GET `/app/api/download/[jobId]/route.ts`
  - [ ] Return video URL when ready or appropriate error

- [ ] Add rate limiting and security (AC: 12)
  - [ ] Implement rate limiting middleware
  - [ ] Use IP-based limiting (1 request/minute)
  - [ ] Add API key authentication for future use
  - [ ] Implement request validation and sanitization

- [ ] Implement comprehensive error handling (AC: 11)
  - [ ] Add try-catch blocks at all integration points
  - [ ] Create custom error classes for different failure types
  - [ ] Log errors to Supabase for monitoring
  - [ ] Return user-friendly error messages

- [ ] Write integration tests (AC: 13)
  - [ ] Test complete workflow from Reddit to video
  - [ ] Test error scenarios (invalid subreddit, API failures)
  - [ ] Test job status tracking
  - [ ] Performance test with concurrent requests

- [ ] Create user documentation (AC: 14, 15)
  - [ ] Write API documentation with examples
  - [ ] Create user guide for video generation process
  - [ ] Document error codes and troubleshooting
  - [ ] Add rate limiting and usage guidelines
  - [ ] Create simple web interface for testing (optional)

## Dev Notes

### Dependencies from Previous Stories
- Requires Reddit service from Story 1.1
- Requires post selection and TTS from Story 1.2
- Uses Supabase client and storage from previous stories

### FFmpeg Configuration
```typescript
// FFmpeg command for combining audio and video
const ffmpegCommand = `
  -i ${videoPath}           // Input video
  -i ${audioPath}           // Input audio
  -c:v libx264              // H.264 codec
  -preset fast              // Encoding speed
  -crf 23                   // Quality (lower = better, 23 is good)
  -c:a aac                  // AAC audio codec
  -b:a 128k                 // Audio bitrate
  -vf "scale=1920:1080"     // Ensure 1080p
  -r 30                     // 30 fps
  -shortest                 // Match shortest input duration
  ${outputPath}
`;

// FFmpeg-static provides the binary
import ffmpegStatic from 'ffmpeg-static';
import { spawn } from 'child_process';
```

### Video Library Structure
```typescript
interface BackgroundVideo {
  id: string;
  filename: string;
  url: string;
  duration_seconds: number;
  category: 'neutral' | 'tech' | 'nature' | 'abstract' | 'gaming';
  mood: 'calm' | 'energetic' | 'mysterious' | 'upbeat';
  description: string;
}

// Selection logic based on subreddit/content
const VIDEO_MAPPINGS = {
  'technology': ['tech', 'abstract'],
  'gaming': ['gaming', 'energetic'],
  'nature': ['nature', 'calm'],
  // Default fallback
  'default': ['neutral', 'abstract']
};
```

### Job Queue Schema
```sql
-- Video generation jobs
CREATE TABLE video_jobs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subreddit TEXT NOT NULL,
  status TEXT CHECK (status IN ('pending', 'fetching_posts', 'selecting_post', 'generating_audio', 'processing_video', 'completed', 'failed')),
  progress INTEGER DEFAULT 0, -- 0-100
  reddit_post_id TEXT,
  audio_file_id UUID REFERENCES audio_files(id),
  video_file_id UUID REFERENCES video_files(id),
  error_message TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Generated videos metadata
CREATE TABLE video_files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  file_url TEXT NOT NULL,
  duration_seconds DECIMAL,
  file_size_bytes INTEGER,
  resolution TEXT DEFAULT '1920x1080',
  created_at TIMESTAMP DEFAULT NOW()
);
```

### API Endpoint Specifications

#### POST /api/generate
```typescript
// Request
{
  subreddit: string;  // Required, validated against Reddit
}

// Response
{
  jobId: string;      // UUID for tracking
  status: 'pending';
  message: 'Video generation started';
}
```

#### GET /api/status/[jobId]
```typescript
// Response
{
  jobId: string;
  status: 'processing' | 'completed' | 'failed';
  progress: number;   // 0-100
  message?: string;   // Current step or error
  videoUrl?: string;  // When completed
}
```

#### GET /api/download/[jobId]
```typescript
// Response (when completed)
{
  videoUrl: string;
  duration: number;
  fileSize: number;
  createdAt: string;
}

// Response (when not ready)
{
  error: 'Video not ready',
  status: 'processing',
  progress: number
}
```

### Workflow Orchestration
```typescript
class VideoGenerationWorkflow {
  async execute(subreddit: string, jobId: string) {
    try {
      // Step 1: Fetch Reddit posts (10%)
      await updateJobStatus(jobId, 'fetching_posts', 10);
      const posts = await redditService.fetchTopPosts(subreddit);

      // Step 2: Select best post (20%)
      await updateJobStatus(jobId, 'selecting_post', 20);
      const selectedPost = await postAnalyzer.selectBest(posts);

      // Step 3: Generate audio (50%)
      await updateJobStatus(jobId, 'generating_audio', 50);
      const audioUrl = await ttsService.generateAudio(selectedPost);

      // Step 4: Process video (80%)
      await updateJobStatus(jobId, 'processing_video', 80);
      const videoUrl = await videoProcessor.createVideo(audioUrl);

      // Step 5: Complete (100%)
      await updateJobStatus(jobId, 'completed', 100);
      return videoUrl;
    } catch (error) {
      await updateJobStatus(jobId, 'failed', -1, error.message);
      throw error;
    }
  }
}
```

### Rate Limiting Implementation
```typescript
// Using simple in-memory store (upgrade to Redis in production)
const rateLimiter = {
  requests: new Map<string, number[]>(),

  check(ip: string): boolean {
    const now = Date.now();
    const minute = 60 * 1000;
    const requests = this.requests.get(ip) || [];

    // Filter requests older than 1 minute
    const recent = requests.filter(time => now - time < minute);

    if (recent.length >= 1) {
      return false; // Rate limit exceeded
    }

    recent.push(now);
    this.requests.set(ip, recent);
    return true;
  }
};
```

### Testing Standards
- Integration tests in `/tests/integration/`
- Use test Supabase instance
- Mock external APIs when possible
- Test files: `*.test.ts`
- Coverage requirement: 80% for critical paths

### User Documentation Structure
```
/docs
  /api
    endpoints.md        # Complete API reference
    examples.md         # Code examples and tutorials
    errors.md          # Error codes and troubleshooting
  user-guide.md        # Step-by-step usage guide
  rate-limits.md       # Usage guidelines and limits
```

### API Documentation Content
1. **Quick Start Guide**
   - Simple curl examples
   - Basic workflow explanation
   - Expected response times

2. **Endpoint Reference**
   - Request/response schemas
   - Authentication requirements
   - Error response formats

3. **Error Handling**
   - Complete error code list
   - Common failure scenarios
   - Retry strategies

4. **Usage Examples**
   - Various subreddit types
   - Handling long-running jobs
   - Best practices for integration

### Simple Web Interface (Optional)
```typescript
// /app/test/page.tsx - Simple test interface
- Input field for subreddit name
- Submit button to start generation
- Progress display with job status
- Download link when complete
- Error display for failures
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-09-29 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_